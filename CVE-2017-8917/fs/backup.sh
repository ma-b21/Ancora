#!/bin/bash

# 用法提示函数
usage() {
    echo "Usage: $0 -s <SOURCE_DIR> -d <BACKUP_ROOT>"
    echo "Example: $0 -s /data -d /backup"
    exit 1
}

# 解析命令行参数
while getopts "s:d:t:" OPT; do
    case "$OPT" in
        s) SOURCE_DIR="$OPTARG" ;;
        d) BACKUP_ROOT="$OPTARG" ;;
        t) TIMESTAMP="$OPTARG" ;;
        *) usage ;;
    esac
done

# 验证必要参数
if [[ -z "$SOURCE_DIR" || -z "$BACKUP_ROOT" ]]; then
    echo "ERROR: Missing required parameters"
    usage
fi

# 配置参数
# 确保BACKUP_ROOT不以斜杠结尾
BACKUP_ROOT="${BACKUP_ROOT%/}"
SOURCE_DIR="${SOURCE_DIR%/}"
# 如果是相对路径，转换为绝对路径
if [[ "${SOURCE_DIR:0:1}" != "/" ]]; then
    SOURCE_DIR="$(pwd)/$SOURCE_DIR"
fi
if [[ "${BACKUP_ROOT:0:1}" != "/" ]]; then
    BACKUP_ROOT="$(pwd)/$BACKUP_ROOT"
fi

LATEST_LINK="${BACKUP_ROOT}/latest"
# NEW_BACKUP_DIR="${BACKUP_ROOT}/${TIMESTAMP}"
NEW_BACKUP_DIR="${BACKUP_ROOT}/new"

# 目录验证
if [[ ! -d "$SOURCE_DIR" ]]; then
    echo "ERROR: Source directory does not exist: $SOURCE_DIR"
    exit 2
fi

# 创建备份目录结构
mkdir -p "$BACKUP_ROOT" || {
    echo "ERROR: Failed to create backup root: $BACKUP_ROOT"
    exit 3
}

# 执行备份操作
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S.%N")
if [[ -L "$LATEST_LINK" ]]; then
    echo "STARTING INCREMENTAL BACKUP..."
    rsync -a --delete --link-dest="$LATEST_LINK" "${SOURCE_DIR}/" "${NEW_BACKUP_DIR}/"
else
    echo "STARTING FULL INITIAL BACKUP..."
    rsync -a "${SOURCE_DIR}/" "${NEW_BACKUP_DIR}/"
fi

# 检查rsync状态
RSYNC_EXIT=$?
if [[ $RSYNC_EXIT -ne 0 ]]; then
    echo "BACKUP FAILED! RSYNC ERROR CODE: $RSYNC_EXIT"
    exit $RSYNC_EXIT
fi

# 备份完成，创建新的备份目录
mv "$NEW_BACKUP_DIR" "${BACKUP_ROOT}/${TIMESTAMP}" || {
    echo "ERROR: Failed to rename new backup directory"
    exit 4
}
NEW_BACKUP_DIR="${BACKUP_ROOT}/${TIMESTAMP}"

# 原子化更新最新链接
ln -sfn "$NEW_BACKUP_DIR" "$LATEST_LINK" && \
echo "BACKUP SUCCESS: ${NEW_BACKUP_DIR}"

exit 0
