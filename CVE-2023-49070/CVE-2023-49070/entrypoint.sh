#!/bin/bash
set -e

# 数据库初始化判断逻辑
if [ "$USE_POSTGRES" = "true" ]; then
    echo "Using PostgreSQL config"
    # 检查有没有 PostgressDemo 插件
    if [ ! -d "/usr/src/apache-ofbiz/plugins/PostgressDemo" ]; then
        echo "PostgressDemo plugin not found, creating it..."
        cp  /tmp/entityengine.xml.postgres \
            /usr/src/apache-ofbiz/framework/entity/config/entityengine.xml
        echo "Creating PostgressDemo plugin"
        ./gradlew createPlugin -PpluginId=PostgressDemo --stacktrace
        echo "Copying build.gradle files for PostgreSQL"
        cp /tmp/build.gradle /usr/src/apache-ofbiz/build.gradle
        cp /tmp/build.gradle.plugin /usr/src/apache-ofbiz/plugins/PostgressDemo/build.gradle
        echo "Starting Apache OFBiz build process..."
        ./gradlew cleanAll loadAll --stacktrace
    else
        echo "Postgres Data already exists, skipping creation"
    fi

else
    echo "Using default Derby config"
    cp /tmp/entityengine.xml.default \
       /usr/src/apache-ofbiz/framework/entity/config/entityengine.xml
fi


exec "$@"
